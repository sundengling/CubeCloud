"use strict";function RecordRTC(l,g){g=g||{};if(!l){throw"MediaStream is mandatory."}if(!g.type){g.type="audio"}var k=this;function f(){if(!g.disableLogs){console.debug("started recording "+g.type+" stream.")}var m=isChrome?window.StereoRecorder:window.MediaStreamRecorder;if(g.type==="video"&&isChrome){m=window.WhammyRecorder}if(g.type==="gif"){m=window.GifRecorder}if(g.type==="canvas"){m=window.CanvasRecorder}if(g.recorderType){m=g.recorderType}b=new m(l);b=mergeProps(b,g);b.onAudioProcessStarted=function(){if(g.onAudioProcessStarted){g.onAudioProcessStarted()}};b.onGifPreview=function(n){if(g.onGifPreview){g.onGifPreview(n)}};b.record();return k}function i(o){if(!b){return console.warn(c)}var n=this;if(!g.disableLogs){console.warn("Stopped recording "+g.type+" stream.")}if(g.type!=="gif"){b.stop(m)}else{b.stop();m()}function m(){for(var r in b){if(k){k[r]=b[r]}if(n){n[r]=b[r]}}var p=b.blob;if(o){var q=URL.createObjectURL(p);o(q)}if(p&&!g.disableLogs){console.debug(p.type,"->",bytesToSize(p.size))}if(!g.autoWriteToDisk){return}e(function(s){var t={};t[g.type+"Blob"]=s;DiskStorage.Store(t)})}}function j(){if(!b){return console.warn(c)}if(b.pause){b.pause()}else{if(!g.disableLogs){console.warn('This recording library is having no "pause" method.')}}}function d(){if(!b){return console.warn(c)}if(b.resume){b.resume()}else{if(!g.disableLogs){console.warn('This recording library is having no "resume" method.')}}}function e(s,q){if(!s){throw"Pass a callback function over getDataURL."}var p=q?q.blob:b.blob;if(!p){if(!g.disableLogs){console.warn("Blob encoder did not yet finished its job.")}setTimeout(function(){e(s,q)},1000);return}if(!!window.Worker){var o=r(function n(t){postMessage(new FileReaderSync().readAsDataURL(t))});o.onmessage=function(t){s(t.data)};o.postMessage(p)}else{var m=new FileReader();m.readAsDataURL(p);m.onload=function(t){s(t.target.result)}}function r(t){var u=URL.createObjectURL(new Blob([t.toString(),"this.onmessage =  function (e) {readFile(e.data);}"],{type:"application/javascript"}));var v=new Worker(u);URL.revokeObjectURL(u);return v}}var c='It seems that "startRecording" is not invoked for '+g.type+" recorder.";var b;var h={startRecording:f,stopRecording:i,pauseRecording:j,resumeRecording:d,getBlob:function(){if(!b){return console.warn(c)}return b.blob},getDataURL:e,toURL:function(){if(!b){return console.warn(c)}return URL.createObjectURL(b.blob)},save:function(p){if(!b){var n=this;setTimeout(function(){n.save(p)},2000);return console.warn(c)}var o=document.createElement("a");o.href=URL.createObjectURL(b.blob);o.target="_blank";o.download=(p||(Math.round(Math.random()*9999999999)+888888888))+"."+b.blob.type.split("/")[1];var m=new MouseEvent("click",{view:window,bubbles:true,cancelable:true});o.dispatchEvent(m);(window.URL||window.webkitURL).revokeObjectURL(o.href)},getFromDisk:function(m){if(!b){return console.warn(c)}RecordRTC.getFromDisk(g.type,m)},setAdvertisementArray:function(o){this.advertisement=[];var n=o.length;for(var m=0;m<n;m++){this.advertisement.push({duration:m,image:o[m]})}},blob:null,bufferSize:0,sampleRate:0,buffer:null,view:null};if(!this){return h}for(var a in h){this[a]=h[a]}return h}RecordRTC.getFromDisk=function(a,b){if(!b){throw"callback is mandatory."}console.log("Getting recorded "+(a==="all"?"blobs":a+" blob ")+" from disk!");DiskStorage.Fetch(function(d,c){if(a!=="all"&&c===a+"Blob"&&b){b(d)}if(a==="all"&&b){b(d,c.replace("Blob",""))}})};RecordRTC.writeToDisk=function(a){console.log("Writing recorded blob(s) to disk!");a=a||{};if(a.audio&&a.video&&a.gif){a.audio.getDataURL(function(b){a.video.getDataURL(function(c){a.gif.getDataURL(function(d){DiskStorage.Store({audioBlob:b,videoBlob:c,gifBlob:d})})})})}else{if(a.audio&&a.video){a.audio.getDataURL(function(b){a.video.getDataURL(function(c){DiskStorage.Store({audioBlob:b,videoBlob:c})})})}else{if(a.audio&&a.gif){a.audio.getDataURL(function(b){a.gif.getDataURL(function(c){DiskStorage.Store({audioBlob:b,gifBlob:c})})})}else{if(a.video&&a.gif){a.video.getDataURL(function(b){a.gif.getDataURL(function(c){DiskStorage.Store({videoBlob:b,gifBlob:c})})})}else{if(a.audio){a.audio.getDataURL(function(b){DiskStorage.Store({audioBlob:b})})}else{if(a.video){a.video.getDataURL(function(b){DiskStorage.Store({videoBlob:b})})}else{if(a.gif){a.gif.getDataURL(function(b){DiskStorage.Store({gifBlob:b})})}}}}}}}};function MRecordRTC(a){this.addStream=function(b){if(b){a=b}};this.mediaType={audio:true,video:true};this.startRecording=function(){if(!isChrome&&a&&a.getAudioTracks&&a.getAudioTracks().length&&a.getVideoTracks().length){this.mediaType.audio=false}if(this.mediaType.audio){this.audioRecorder=new RecordRTC(a,{type:"audio",bufferSize:this.bufferSize,sampleRate:this.sampleRate});this.audioRecorder.startRecording()}if(this.mediaType.video){this.videoRecorder=new RecordRTC(a,{type:"video",video:this.video,canvas:this.canvas});this.videoRecorder.startRecording()}if(this.mediaType.gif){this.gifRecorder=new RecordRTC(a,{type:"gif",frameRate:this.frameRate||200,quality:this.quality||10});this.gifRecorder.startRecording()}};this.stopRecording=function(b){b=b||function(){};if(this.audioRecorder){this.audioRecorder.stopRecording(function(c){b(c,"audio")})}if(this.videoRecorder){this.videoRecorder.stopRecording(function(c){b(c,"video")})}if(this.gifRecorder){this.gifRecorder.stopRecording(function(c){b(c,"gif")})}};this.getBlob=function(c){var b={};if(this.audioRecorder){b.audio=this.audioRecorder.getBlob()}if(this.videoRecorder){b.video=this.videoRecorder.getBlob()}if(this.gifRecorder){b.gif=this.gifRecorder.getBlob()}if(c){c(b)}};this.getDataURL=function(d){this.getBlob(function(e){b(e.audio,function(f){b(e.video,function(g){d({audio:f,video:g})})})});function b(h,i){if(!!window.Worker){var g=c(function f(j){postMessage(new FileReaderSync().readAsDataURL(j))});g.onmessage=function(j){i(j.data)};g.postMessage(h)}else{var e=new FileReader();e.readAsDataURL(h);e.onload=function(j){i(j.target.result)}}}function c(e){var f=URL.createObjectURL(new Blob([e.toString(),"this.onmessage =  function (e) {readFile(e.data);}"],{type:"application/javascript"}));var g=new Worker(f);URL.revokeObjectURL(f);return g}};this.writeToDisk=function(){RecordRTC.writeToDisk({audio:this.audioRecorder,video:this.videoRecorder,gif:this.gifRecorder})};this.save=function(b){b=b||{audio:true,video:true,gif:true};if(!!b.audio&&this.audioRecorder){this.audioRecorder.save(typeof b.audio==="string"?b.audio:"")}if(!!b.video&&this.videoRecorder){this.videoRecorder.save(typeof b.video==="string"?b.video:"")}if(!!b.gif&&this.gifRecorder){this.gifRecorder.save(typeof b.gif==="string"?b.gif:"")}}}MRecordRTC.getFromDisk=RecordRTC.getFromDisk;MRecordRTC.writeToDisk=RecordRTC.writeToDisk;if(!window.requestAnimationFrame){window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame}if(!window.AudioContext){window.AudioContext=window.webkitAudioContext||window.mozAudioContext}window.URL=window.URL||window.webkitURL;navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;if(window.webkitMediaStream){window.MediaStream=window.webkitMediaStream}var isChrome=!!navigator.webkitGetUserMedia;function mergeProps(c,a){a=reformatProps(a);for(var b in a){if(typeof a[b]!=="function"){c[b]=a[b]}}return c}function reformatProps(c){var a={};for(var d in c){if(d.indexOf("-")!==-1){var e=d.split("-");var b=e[0]+e[1].split("")[0].toUpperCase()+e[1].substr(1);a[b]=c[d]}else{a[d]=c[d]}}return a}if(location.href.indexOf("file:")===0){console.error("Please load this HTML file on HTTP or HTTPS.")}function bytesToSize(a){var b=1000;var d=["Bytes","KB","MB","GB","TB"];if(a===0){return"0 Bytes"}var c=parseInt(Math.floor(Math.log(a)/Math.log(b)),10);return(a/Math.pow(b,c)).toPrecision(3)+" "+d[c]}var Storage={AudioContext:window.AudioContext||window.webkitAudioContext};function MediaStreamRecorder(c){var b=this;if(b.mimeType&&b.mimeType!=="video/webm"&&c.getVideoTracks&&c.getVideoTracks().length){var e=new AudioContext();var g=e.createMediaStreamSource(c);var a=e.createMediaStreamDestination();g.connect(a);c=a.stream}var d=false;this.record=function(){f=new window.MediaRecorder(c);f.ondataavailable=function(h){if(d){return}if(!h.data.size){if(!b.disableLogs){console.warn("Recording of",h.data.type,"failed.")}return}d=true;b.blob=new Blob([h.data],{type:h.data.type||b.mimeType||"audio/ogg"});if(b.callback){b.callback()}};f.onerror=function(h){if(!b.disableLogs){console.warn(h)}f.stop();b.record(0)};f.start(0);if(b.onAudioProcessStarted){b.onAudioProcessStarted()}};this.stop=function(h){if(!f){return}this.callback=h;if(f.state==="recording"){f.stop()}};this.pause=function(){if(!f){return}if(f.state==="recording"){f.pause();if(!this.disableLogs){console.debug("Paused recording.")}}};this.resume=function(){if(!f){return}if(f.state==="paused"){f.resume();if(!this.disableLogs){console.debug("Resumed recording.")}}};var f}function StereoRecorder(b){var a=this;this.record=function(){c=new StereoAudioRecorder(b,this);c.onAudioProcessStarted=function(){if(a.onAudioProcessStarted){a.onAudioProcessStarted()}};c.record()};this.stop=function(d){if(!c){return}c.stop(function(){for(var e in c){a[e]=c[e]}if(d){d()}})};this.pause=function(){if(!c){return}c.pause()};this.resume=function(){if(!c){return}c.resume()};var c}var __stereoAudioRecorderJavacriptNode;function StereoAudioRecorder(p,f){if(!p.getAudioTracks().length){throw"Your stream has no audio tracks."}var n=this;var e=[];var i=[];var b=false;var k=0;this.record=function(){e.length=i.length=0;k=0;b=true};function m(s,t){function r(L){var E=L.leftBuffers;var A=L.rightBuffers;var w=L.sampleRate;E=z(E[0],E[1]);A=z(A[0],A[1]);function z(Q,R){var M=new Float64Array(R);var S=0;var O=Q.length;for(var P=0;P<O;P++){var N=Q[P];M.set(N,S);S+=N.length}return M}function H(O,N){var Q=O.length+N.length;var M=new Float64Array(Q);var R=0;for(var P=0;P<Q;){M[P++]=O[R];M[P++]=N[R];R++}return M}function y(M,Q,O){var N=O.length;for(var P=0;P<N;P++){M.setUint8(Q+P,O.charCodeAt(P))}}var F=H(E,A);var v=F.length;var C=44+v*2;var J=new ArrayBuffer(C);var D=new DataView(J);y(D,0,"RIFF");var x=4;D.setUint32(x,44+v*2,true);y(D,8,"WAVE");y(D,12,"fmt ");D.setUint32(16,16,true);D.setUint16(20,1,true);D.setUint16(22,2,true);D.setUint32(24,w,true);D.setUint32(28,w*x,true);D.setUint16(32,x,true);D.setUint16(34,16,true);y(D,36,"data");D.setUint32(40,v*2,true);var B=44,I;for(var K=0;K<v;K++,B+=2){var G=Math.max(-1,Math.min(1,F[K]));var u=G<0?G*32768:G*32767;if(L.leftChannel){if(u!==I){D.setInt16(B,u,true)}I=u}else{D.setInt16(B,u,true)}}postMessage({buffer:J,view:D})}var q=h(r);q.onmessage=function(u){t(u.data.buffer,u.data.view)};q.postMessage(s)}function h(q){var r=URL.createObjectURL(new Blob([q.toString(),"this.onmessage =  function (e) {"+q.name+"(e.data);}"],{type:"application/javascript"}));var s=new Worker(r);URL.revokeObjectURL(r);return s}this.stop=function(q){b=false;a.disconnect();m({sampleRate:l,leftChannel:f.leftChannel,leftBuffers:[e,k],rightBuffers:[i,k]},function(s,r){n.blob=new Blob([r],{type:"audio/wav"});n.buffer=new ArrayBuffer(r);n.view=r;n.sampleRate=l;n.bufferSize=d;n.length=k;if(q){q()}g=false})};if(!Storage.AudioContextConstructor){Storage.AudioContextConstructor=new Storage.AudioContext()}var c=Storage.AudioContextConstructor;var a=c.createMediaStreamSource(p);var o=[0,256,512,1024,2048,4096,8192,16384];var d=typeof f.bufferSize==="undefined"?4096:f.bufferSize;if(o.indexOf(d)===-1){if(!f.disableLogs){console.warn("Legal values for buffer-size are "+JSON.stringify(o,null,"\t"))}}var l=typeof f.sampleRate!=="undefined"?f.sampleRate:c.sampleRate||44100;if(l<22050||l>96000){if(!f.disableLogs){console.warn("sample-rate must be under range 22050 and 96000.")}}if(c.createJavaScriptNode){__stereoAudioRecorderJavacriptNode=c.createJavaScriptNode(d,2,2)}else{if(c.createScriptProcessor){__stereoAudioRecorderJavacriptNode=c.createScriptProcessor(d,2,2)}else{throw"WebAudio API has no support on this browser."}}a.connect(__stereoAudioRecorderJavacriptNode);d=__stereoAudioRecorderJavacriptNode.bufferSize;if(!f.disableLogs){console.log("sample-rate",l);console.log("buffer-size",d)}var j=false;this.pause=function(){j=true;if(!f.disableLogs){console.debug("Paused recording.")}};this.resume=function(){j=false;if(!f.disableLogs){console.debug("Resumed recording.")}};var g=false;__stereoAudioRecorderJavacriptNode.onaudioprocess=function(s){if(j){return}if(p.ended){__stereoAudioRecorderJavacriptNode.onaudioprocess=function(){};return}if(!b){a.disconnect();return}if(!g){g=true;if(n.onAudioProcessStarted){n.onAudioProcessStarted()}}var r=s.inputBuffer.getChannelData(0);var q=s.inputBuffer.getChannelData(1);e.push(new Float32Array(r));i.push(new Float32Array(q));k+=d};__stereoAudioRecorderJavacriptNode.connect(c.destination)}function CanvasRecorder(f){if(!window.html2canvas){throw"Please link: //cdn.webrtc-experiment.com/screenshot.js"}var c;this.record=function(){c=true;d.frames=[];a()};this.stop=function(h){c=false;var g=this;d.compile(function(i){g.blob=i;if(g.blob.forEach){g.blob=new Blob([],{type:"video/webm"})}if(h){h(g.blob)}})};var b=false;this.pause=function(){b=true;if(!this.disableLogs){console.debug("Paused recording.")}};this.resume=function(){b=false;if(!this.disableLogs){console.debug("Resumed recording.")}};function a(){if(b){e=new Date().getTime();return setTimeout(a,100)}window.html2canvas(f,{onrendered:function(g){var h=new Date().getTime()-e;if(!h){return a()}e=new Date().getTime();d.frames.push({duration:h,image:g.toDataURL("image/webp")});if(c){requestAnimationFrame(a)}}})}var e=new Date().getTime();var d=new Whammy.Video(100)}function WhammyRecorder(j){this.record=function(){if(!this.width){this.width=320}if(!this.height){this.height=240}if(!this.video){this.video={width:this.width,height:this.height}}if(!this.canvas){this.canvas={width:this.width,height:this.height}}d.width=this.canvas.width;d.height=this.canvas.height;c=d.getContext("2d");if(this.video&&this.video instanceof HTMLVideoElement){b=this.video.cloneNode()}else{b=document.createElement("video");b.src=URL.createObjectURL(j);b.width=this.video.width;b.height=this.video.height}b.muted=true;b.play();a=new Date().getTime();i=new Whammy.Video();if(!this.disableLogs){console.log("canvas resolutions",d.width,"*",d.height);console.log("video width/height",b.width||d.width,"*",b.height||d.height)}f()};function f(){var k=new Date().getTime()-a;if(!k){return setTimeout(f,10)}if(g){a=new Date().getTime();return setTimeout(f,100)}a=new Date().getTime();if(b.paused){b.play()}c.drawImage(b,0,0,d.width,d.height);i.frames.push({duration:k,image:d.toDataURL("image/webp")});if(!h){setTimeout(f,10)}}function e(E,G,w,o){var D=document.createElement("canvas");D.width=d.width;D.height=d.height;var t=D.getContext("2d");var v=[];var y=G===-1;var s=(G&&G>0&&G<=E.length)?G:E.length;var F={r:0,g:0,b:0};var p=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2));var q=w&&w>=0&&w<=1?w:0;var m=o&&o>=0&&o<=1?o:0;var n=false;for(var A=0;A<s;A++){var x,k,C;if(!n){var u=new Image();u.src=E[A].image;t.drawImage(u,0,0,d.width,d.height);var z=t.getImageData(0,0,d.width,d.height);x=0;k=z.data.length;C=z.data.length/4;for(var l=0;l<k;l+=4){var r={r:z.data[l],g:z.data[l+1],b:z.data[l+2]};var B=Math.sqrt(Math.pow(r.r-F.r,2)+Math.pow(r.g-F.g,2)+Math.pow(r.b-F.b,2));if(B<=p*q){x++}}}if(!n&&C-x<=C*m){}else{if(y){n=true}v.push(E[A])}}v=v.concat(E.slice(s));if(v.length<=0){v.push(E[E.length-1])}return v}var h=false;this.stop=function(l){h=true;var k=this;setTimeout(function(){i.frames=e(i.frames,-1);if(this.advertisement&&this.advertisement.length){i.frames=this.advertisement.concat(i.frames)}i.compile(function(m){k.blob=m;if(k.blob.forEach){k.blob=new Blob([],{type:"video/webm"})}if(l){l(k.blob)}})},10)};var g=false;this.pause=function(){g=true;if(!this.disableLogs){console.debug("Paused recording.")}};this.resume=function(){g=false;if(!this.disableLogs){console.debug("Resumed recording.")}};var d=document.createElement("canvas");var c=d.getContext("2d");var b;var a;var i}var Whammy=(function(){function b(d){this.frames=[];this.duration=d||1;this.quality=100}b.prototype.add=function(e,d){if("canvas" in e){e=e.canvas}if("toDataURL" in e){e=e.toDataURL("image/webp",this.quality)}if(!(/^data:image\/webp;base64,/ig).test(e)){throw"Input must be formatted properly as a base64 encoded DataURI of type image/webp"}this.frames.push({image:e,duration:d||this.duration})};function c(d){var e=URL.createObjectURL(new Blob([d.toString(),"this.onmessage =  function (e) {"+d.name+"(e.data);}"],{type:"application/javascript"}));var f=new Worker(e);URL.revokeObjectURL(e);return f}function a(o){function j(y){var v=p(y);if(!v){return[]}var s=30000;var w=[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1000000,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:d(v.duration),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:29637},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:v.width,id:176},{data:v.height,id:186}]}]}]}]}];var z=0;var B=0;while(z<y.length){var x=[];var u=0;do{x.push(y[z]);u+=y[z].duration;z++}while(z<y.length&&u<s);var t=0;var A={id:524531317,data:i(B,t,x)};w[1].data.push(A);B+=u}return q(w)}function i(t,u,s){return[{data:t,id:231}].concat(s.map(function(v){var w=r({discardable:0,frame:v.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(u)});u+=v.duration;return{data:w,id:163}}))}function p(w){if(!w[0]){postMessage({error:"Something went wrong. Maybe WebP format is not supported in the current browser."});return}var u=w[0].width,s=w[0].height,v=w[0].duration;for(var t=1;t<w.length;t++){v+=w[t].duration}return{duration:v,width:u,height:s}}function f(s){var t=[];while(s>0){t.push(s&255);s=s>>8}return new Uint8Array(t.reverse())}function m(s){return new Uint8Array(s.split("").map(function(t){return t.charCodeAt(0)}))}function h(u){var t=[];var v=(u.length%8)?(new Array(1+8-(u.length%8))).join("0"):"";u=v+u;for(var s=0;s<u.length;s+=8){t.push(parseInt(u.substr(s,8),2))}return new Uint8Array(t)}function q(z){var u=[];for(var w=0;w<z.length;w++){var v=z[w].data;if(typeof v==="object"){v=q(v)}if(typeof v==="number"){v=h(v.toString(2))}if(typeof v==="string"){v=m(v)}var x=v.size||v.byteLength||v.length;var y=Math.ceil(Math.ceil(Math.log(x)/Math.log(2))/8);var s=x.toString(2);var t=(new Array((y*7+7+1)-s.length)).join("0")+s;var A=(new Array(y)).join("0")+"1"+t;u.push(f(z[w].id));u.push(h(A));u.push(v)}return new Blob(u,{type:"video/webm"})}function l(u){var t="";var v=(u.length%8)?(new Array(1+8-(u.length%8))).join("0"):"";u=v+u;for(var s=0;s<u.length;s+=8){t+=String.fromCharCode(parseInt(u.substr(s,8),2))}return t}function r(u){var s=0;if(u.keyframe){s|=128}if(u.invisible){s|=8}if(u.lacing){s|=(u.lacing<<1)}if(u.discardable){s|=1}if(u.trackNum>127){throw"TrackNumber > 127 not supported"}var t=[u.trackNum|128,u.timecode>>8,u.timecode&255,s].map(function(v){return String.fromCharCode(v)}).join("")+u.frame;return t}function g(z){var t=z.RIFF[0].WEBP[0];var x=t.indexOf("\x9d\x01\x2a");for(var v=0,y=[];v<4;v++){y[v]=t.charCodeAt(x+3+v)}var w,s,u;u=(y[1]<<8)|y[0];w=u&16383;u=(y[3]<<8)|y[2];s=u&16383;return{width:w,height:s,data:t,riff:z}}function n(s,t){return parseInt(s.substr(t+4,4).split("").map(function(u){var v=u.charCodeAt(0).toString(2);return(new Array(8-v.length+1)).join("0")+v}).join(""),2)}function k(t){var v=0;var x={};while(v<t.length){var w=t.substr(v,4);var s=n(t,v);var u=t.substr(v+4+4,s);v+=4+4+s;x[w]=x[w]||[];if(w==="RIFF"||w==="LIST"){x[w].push(k(u))}else{x[w].push(u)}}return x}function d(s){return[].slice.call(new Uint8Array((new Float64Array([s])).buffer),0).map(function(t){return String.fromCharCode(t)}).reverse().join("")}var e=new j(o.map(function(t){var s=g(k(atob(t.image.slice(23))));s.duration=t.duration;return s}));postMessage(e)}b.prototype.compile=function(e){var d=c(a);d.onmessage=function(f){if(f.data.error){console.error(f.data.error);return}e(f.data)};d.postMessage(this.frames)};return{Video:b}})();var DiskStorage={init:function(){var c=this;var b=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB;var d=1;var g=this.dbName||location.href.replace(/\/|:|#|%|\.|\[|\]/g,""),a;var f=b.open(g,d);function e(i){i.createObjectStore(c.dataStoreName)}function h(){var j=a.transaction([c.dataStoreName],"readwrite");if(c.videoBlob){j.objectStore(c.dataStoreName).put(c.videoBlob,"videoBlob")}if(c.gifBlob){j.objectStore(c.dataStoreName).put(c.gifBlob,"gifBlob")}if(c.audioBlob){j.objectStore(c.dataStoreName).put(c.audioBlob,"audioBlob")}function i(k){j.objectStore(c.dataStoreName).get(k).onsuccess=function(l){if(c.callback){c.callback(l.target.result,k)}}}i("audioBlob");i("videoBlob");i("gifBlob")}f.onerror=c.onError;f.onsuccess=function(){a=f.result;a.onerror=c.onError;if(a.setVersion){if(a.version!==d){var i=a.setVersion(d);i.onsuccess=function(){e(a);h()}}else{h()}}else{h()}};f.onupgradeneeded=function(i){e(i.target.result)}},Fetch:function(a){this.callback=a;this.init();return this},Store:function(a){this.audioBlob=a.audioBlob;this.videoBlob=a.videoBlob;this.gifBlob=a.gifBlob;this.init();return this},onError:function(a){console.error(JSON.stringify(a,null,"\t"))},dataStoreName:"recordRTC",dbName:null};function GifRecorder(j){if(!window.GIFEncoder){throw"Please link: https://cdn.webrtc-experiment.com/gif-recorder.js"}this.record=function(){if(!this.width){this.width=a.offsetWidth||320}if(!this.height){this.height=a.offsetHeight||240}if(!this.video){this.video={width:this.width,height:this.height}}if(!this.canvas){this.canvas={width:this.width,height:this.height}}d.width=this.canvas.width;d.height=this.canvas.height;a.width=this.video.width;a.height=this.video.height;g=new window.GIFEncoder();g.setRepeat(0);g.setDelay(this.frameRate||200);g.setQuality(this.quality||10);g.start();c=Date.now();var k=this;function l(m){if(e){return setTimeout(function(){l(m)},100)}h=requestAnimationFrame(l);if(typeof i===undefined){i=m}if(m-i<90){return}if(a.paused){a.play()}b.drawImage(a,0,0,d.width,d.height);if(k.onGifPreview){k.onGifPreview(d.toDataURL("image/png"))}g.addFrame(b);i=m}h=requestAnimationFrame(l)};this.stop=function(){if(h){cancelAnimationFrame(h)}f=Date.now();this.blob=new Blob([new Uint8Array(g.stream().bin)],{type:"image/gif"});g.stream().bin=[]};var e=false;this.pause=function(){e=true;if(!this.disableLogs){console.debug("Paused recording.")}};this.resume=function(){e=false;if(!this.disableLogs){console.debug("Resumed recording.")}};var d=document.createElement("canvas");var b=d.getContext("2d");var a=document.createElement("video");a.muted=true;a.autoplay=true;a.src=URL.createObjectURL(j);a.play();var h=null;var c,f,i;var g}var CubeRecorder=Class({isFirefox:!!navigator.mozGetUserMedia,recording:false,recordEnd:null,maxWidth:320,maxHeight:240,maxFrameRate:15,minFrameRate:5,recordVideo:null,recordAudio:null,videoUrl:null,audioUrl:null,preview:null,stream:null,startTime:0,duration:0,db:null,ctor:function(a){if(undefined!==a){this.preview=a}},dispose:function(){this.stream=null;this.recordEnd=null},startRecording:function(c){if(this.recording){return false}this.recording=true;this.startTime=0;this.duration=0;var a=this;var b=function(e){a.stream=e;if(null!=a.preview){a.attachMediaStream(a.preview,e);a.preview.muted=true;a.preview.controls=false;a.preview.style.visibility="visible"}if(!a.isFirefox){a.recordAudio=RecordRTC(e,{bufferSize:16384,sampleRate:45000,onAudioProcessStarted:function(){a.recordVideo.startRecording()}})}a.recordVideo=RecordRTC(e,{type:"video"});if(null!=a.recordAudio){a.recordAudio.startRecording()}else{a.recordVideo.startRecording()}a.startTime=Date.now()};if(c===undefined||null==c){var d=null;if(a.isFirefox){d={width:{min:160,max:a.maxWidth},height:{min:120,max:a.maxHeight},frameRate:parseInt(a.maxFrameRate),require:["width","height","frameRate"]}}else{d={mandatory:{maxWidth:a.maxWidth,maxHeight:a.maxHeight,minWidth:160,minHeight:120,maxFrameRate:a.maxFrameRate,minFrameRate:a.minFrameRate}}}navigator.getUserMedia({audio:true,video:d},function(e){b(e)},function(e){alert(JSON.stringify(e))})}else{b(c)}return true},stopRecording:function(c){if(!this.recording){return false}this.recording=false;var b=(null!=this.recordVideo)?1:0;b+=(null!=this.recordAudio)?1:0;var a=this;if(null!=this.recordVideo){this.recordVideo.stopRecording(function(d){a.duration=Date.now()-a.startTime;a.videoUrl=d;--b;if("undefined"!==c&&0==b){c.call(null,a)}if(null!=a.recordEnd){a.recordEnd.call(null,a)}if(null!=a.preview){a.preview.src="";try{a.stream.stop()}catch(f){}}a.stream=null})}if(null!=this.recordAudio){this.recordAudio.stopRecording(function(d){a.audioUrl=d;--b;if("undefined"!==c&&0==b){c.call(null,a)}})}},replay:function(c,b){if(this.recording){return false}var a=this;if(null!=this.recordAudio){c.onplay=function(d){b.play()};c.onpause=function(d){b.pause()};b.muted=false;if(window.URL){b.src=window.URL.createObjectURL(this.recordAudio.getBlob())}else{b.src=this.recordAudio.getBlob()}}if(null!=this.recordVideo){c.muted=false;c.controls=true;c.onended=function(d){if(a.isFirefox){if(window.URL){c.src=window.URL.createObjectURL(a.recordVideo.getBlob())}else{c.src=a.recordVideo.getBlob()}}else{if(null!=a.recordAudio){b.pause();if(window.URL){b.src=window.URL.createObjectURL(a.recordAudio.getBlob())}else{b.src=a.recordAudio.getBlob()}}}};if(window.URL){c.src=window.URL.createObjectURL(this.recordVideo.getBlob())}else{c.src=this.recordVideo.getBlob()}}return true},getVideoUrl:function(){return this.videoUrl},save:function(m,h,l){var o=(null!=this.recordVideo);var r=(null!=this.recordAudio);var n=null;var j=null;var g=o?this.recordVideo.blob.size:0;var d=r?this.recordAudio.blob.size:0;var f=new Date(this.startTime);var k=[m,"_",f.getFullYear(),(f.getMonth()+1)<10?"0"+(f.getMonth()+1):(f.getMonth()+1),f.getDate()<10?"0"+f.getDate():f.getDate(),f.getHours()<10?"0"+f.getHours():f.getHours(),f.getMinutes()<10?"0"+f.getMinutes():f.getMinutes(),f.getSeconds()<10?"0"+f.getSeconds():f.getSeconds(),"_",parseInt(this.duration/1000)];var q=k.join("");var i=this;var b=this.startTime;var e=null;var p=null;if(o){var a=new FileReader();a.onload=function(s){n=s.target.result;if(r&&null!=j){e={time:b,video:{name:q+".webm",size:g,data:n},audio:{name:q+".wav",size:d,data:j}};i._save(p,e,h,l)}else{if(!r){e={time:b,video:{name:q+".webm",size:g,data:n}};i._save(p,e,h,l)}}};a.readAsDataURL(this.recordVideo.blob)}if(r){var a=new FileReader();a.onload=function(s){j=s.target.result;if(o&&null!=n){e={time:b,video:{name:q+".webm",size:g,data:n},audio:{name:q+".wav",size:d,data:j}};i._save(p,e,h,l)}else{if(!o){e={time:b,audio:{name:q+".wav",size:d,data:j}};i._save(p,e,h,l)}}};a.readAsDataURL(this.recordAudio.blob)}var c=window.indexedDB.open("_cube_recording",1);c.onerror=function(s){Logger.e("CubeRecorder","Can NOT use IndexedDB")};c.onupgradeneeded=function(s){p=s.target.result;if(!p.objectStoreNames.contains("recording")){var t=p.createObjectStore("recording",{keyPath:"time"});t.createIndex("time","time",{unique:true})}};c.onsuccess=function(s){p=s.target.result;i._save(p,e,h,l)};return b},_save:function(b,d,a,c){if(null==b||null==d){return}var e=b.transaction(["recording"],"readwrite");e.oncomplete=function(f){a.call(null,d)};e.onerror=function(f){c.call(null,d)};e.objectStore("recording").add(d)},uploadTo:function(b,d,c,a){return this._upload(b,d,"cube",c,a)},upload:function(b,d,f,a,e){if(null==b||null==d){return false}var c=true;if("undefined"!==e){c=e}return this._upload(c,{account:b},d,f,a)},_upload:function(n,b,h,l,k){if(null==n||null==b||null==h){return false}var c=new Date(this.startTime);var j=[h,"_",c.getFullYear(),(c.getMonth()+1)<10?"0"+(c.getMonth()+1):(c.getMonth()+1),c.getDate()<10?"0"+c.getDate():c.getDate(),c.getHours()<10?"0"+c.getHours():c.getHours(),c.getMinutes()<10?"0"+c.getMinutes():c.getMinutes(),c.getSeconds()<10?"0"+c.getSeconds():c.getSeconds(),"_",parseInt(this.duration/1000)];var d=j.join("");var m=this;var a=(null!=this.recordVideo);var e=(null!=this.recordAudio);var g=null;var i=null;if(a){var f=new FileReader();f.onload=function(o){g=o.target.result;if(e&&null!=i){m._post(n,b,{name:d+".webm",size:m.recordVideo.blob.size,data:g},{name:d+".wav",size:m.recordAudio.blob.size,data:i},l,k)}else{if(!e){m._post(n,b,{name:d+".webm",size:m.recordVideo.blob.size,data:g},null,l,k)}}};f.readAsDataURL(this.recordVideo.blob)}if(e){var f=new FileReader();f.onload=function(o){i=o.target.result;if(a&&null!=g){m._post(n,b,{name:d+".webm",size:m.recordVideo.blob.size,data:g},{name:d+".wav",size:m.recordAudio.blob.size,data:i},l,k)}else{if(!a){m._post(n,b,null,{name:d+".wav",size:m.recordAudio.blob.size,data:i},l,k)}}};f.readAsDataURL(this.recordAudio.blob)}return true},_uploadFromDB:function(d,h,g,c){var f=this.startTime;var b=this;var a=null;var e=window.indexedDB.open("_cube_recording",1);e.onerror=function(i){Logger.e("CubeRecorder","Can NOT use IndexedDB");c.call(null,b)};e.onupgradeneeded=function(i){a=i.target.result;b.db=a;if(!a.objectStoreNames.contains("recording")){var j=a.createObjectStore("recording",{keyPath:"time"});j.createIndex("time","time",{unique:true})}};e.onsuccess=function(j){a=j.target.result;b.db=a;var l=a.transaction(["recording"]);var k=l.objectStore("recording");var i=k.get(f);i.onsuccess=function(o){var p=o.target.result;var n=(undefined!==p.video)?p.video:null;var m=(undefined!==p.audio)?p.audio:null;b._post(d,h,n,m,g,c);Logger.d("CubeRecorder","Post data to "+d)}}},_deleteFromDB:function(){var b=this;if(null==b.db){var a=null;var c=window.indexedDB.open("_cube_recording",1);c.onerror=function(d){Logger.e("CubeRecorder","Can NOT use IndexedDB")};c.onupgradeneeded=function(d){a=d.target.result;b.db=a;if(!a.objectStoreNames.contains("recording")){var e=a.createObjectStore("recording",{keyPath:"time"});e.createIndex("time","time",{unique:true})}};c.onsuccess=function(d){a=d.target.result;b.db=a;a.transaction(["recording"],"readwrite").objectStore("recording")["delete"](b.startTime)}}else{b.db.transaction(["recording"],"readwrite").objectStore("recording")["delete"](b.startTime)}},_post:function(h,g,a,d,f,e){var c=new FormData();c.append("param",JSON.stringify(g));if(null!=a){c.append("video-filename",a.name);c.append("video-size",a.size);c.append("video-data",a.data)}if(null!=d){c.append("audio-filename",d.name);c.append("audio-size",d.size);c.append("audio-data",d.data)}var i=this;var b=new XMLHttpRequest();b.onreadystatechange=function(){if(b.readyState==4){if(b.status==200){if(undefined!==f){f.call(null,i,g)}}else{if(undefined!==e){e.call(null,i,g)}}}};if(typeof h==="string"){b.open("POST",h)}else{if(h){b.open("POST",window._cube_cross.host+"/archive/save")}else{b.open("POST","archive/save")}}b.send(c)},clear:function(){this.recordVideo=null;this.recordAudio=null},getDuration:function(){if(0==this.startTime){return 0}if(0==this.duration){return Date.now()-this.startTime}return this.duration},getSize:function(){var a=0;a+=(null!=this.recordVideo)?this.recordVideo.blob.size:0;a+=(null!=this.recordAudio)?this.recordAudio.blob.size:0;return a},attachMediaStream:function(a,b){if(window.URL){a.src=window.URL.createObjectURL(b)}else{a.src=b}a.onloadedmetadata=function(c){a.play()}}});var CubeAdvancedRecorder=Class({preview:null,maxWidth:320,maxHeight:240,maxFrameRate:20,minFrameRate:5,interval:30000,stream:null,recorder:null,timer:0,storeKeyList:[],durationList:[],sizeList:[],prefix:"cube",ctor:function(b,a){if(undefined!==b&&null!=b){this.preview=b}this.interval=a.interval||30000;Logger.d("AdvancedRecorder","config: "+JSON.stringify(a))},startRecording:function(c){if(this.timer>0){return false}this.prefix=""+parseInt(Date.now()/1000);var a=this;var b=function(e){a.stream=e;if(null!=a.preview){a.attachMediaStream(a.preview,e);a.preview.muted=true;a.preview.controls=false;a.preview.style.visibility="visible"}a.recorder=new CubeRecorder();a.recorder.startRecording(a.stream);a.timer=setTimeout(function(){a._continue()},a.interval)};if(c===undefined||null==c){var d=null;if(utils.isFirefox){d={width:{min:160,max:a.maxWidth},height:{min:120,max:a.maxHeight},frameRate:parseInt(a.maxFrameRate),require:["width","height","frameRate"]}}else{d={mandatory:{maxWidth:a.maxWidth,maxHeight:a.maxHeight,minWidth:160,minHeight:120,maxFrameRate:a.maxFrameRate,minFrameRate:a.minFrameRate}}}navigator.getUserMedia({audio:true,video:d},function(e){b(e)},function(e){alert(JSON.stringify(e))})}else{b(c)}return true},stopRecording:function(b){clearTimeout(this.timer);this.timer=0;var a=this;this.recorder.stopRecording(function(d){a.storeKeyList.push(a.recorder.startTime+0);a.durationList.push(a.recorder.duration+0);a.sizeList.push(a.recorder.getSize()+0);var c=a.recorder;var f=c.save(a.prefix,function(){c.dispose();c=null});a.recorder=null;if(null!=a.preview){a.preview.src=utils.isFirefox?null:"";try{a.stream.stop()}catch(g){}}a.stream=null;b.call(null,a)})},pauseRecording:function(){},resumeRecording:function(){},uploadRecordings:function(c,g,f,b){if(this.storeKeyList.length>0){var d=this.storeKeyList.shift();var e=new CubeRecorder();e.startTime=d;var a=this;e._uploadFromDB(c,g,function(){e._deleteFromDB();if(a.storeKeyList.length>0){setTimeout(function(){a.uploadRecordings(c,g,f,b)},10)}else{f.call(null,a,g)}e=null},b)}return true},replay:function(b,a){alert()},clearAll:function(){var b=this;var a=null;var c=window.indexedDB.open("_cube_recording",1);c.onerror=function(d){Logger.e("CubeRecorder","Can NOT use IndexedDB")};c.onupgradeneeded=function(d){a=d.target.result;if(!a.objectStoreNames.contains("recording")){var e=a.createObjectStore("recording",{keyPath:"time"});e.createIndex("time","time",{unique:true})}};c.onsuccess=function(d){a=d.target.result}},numRecordings:function(){return this.storeKeyList.length},getDuration:function(){var a=0;if(this.durationList.length>0){for(var b=0;b<this.durationList.length;++b){a+=this.durationList[b]}}if(null!=this.recorder){a+=this.recorder.getDuration()}return a},getSize:function(){var a=0;if(this.sizeList.length>0){for(var b=0;b<this.sizeList.length;++b){a+=this.sizeList[b]}}if(null!=this.recorder&&!this.recorder.recording){a+=this.recorder.getSize()}return a},_continue:function(){if(null==this.recorder){return}clearTimeout(this.timer);var b=this;var a=b.recorder;this.recorder.stopRecording(function(c){var d=a.save(b.prefix,function(){a.dispose()});b.storeKeyList.push(d);b.durationList.push(a.duration+0);b.sizeList.push(a.getSize()+0)});b.recorder=new CubeRecorder();b.recorder.startRecording(b.stream);b.timer=setTimeout(function(){b._continue()},b.interval)},attachMediaStream:function(a,b){if(window.URL){a.src=window.URL.createObjectURL(b)}else{a.src=b}a.onloadedmetadata=function(c){a.play()}}});