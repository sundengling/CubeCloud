var CubeMessageWorkerDelegate=Class({engine:null,ctor:function(a){this.engine=a},didMessageSend:function(a){if(null!=this.engine.messageListener){this.engine.messageListener.onSent(this.engine.session,a)}},didMessageReceive:function(a){if(null!=this.engine.messageListener){this.engine.messageListener.onReceived(this.engine.session,a)}},didMessageFailed:function(b,a){if(null!=this.engine.messageListener){this.engine.messageListener.onMessageFailed(this.engine.session,b,a)}}});var CubeTextMessage=Class({type:"text",receiver:null,sender:null,sendTime:0,receiveTime:0,content:null,ctor:function(b,a){this.receiver={name:b};this.content=a},getContent:function(){return this.content},getReceiver:function(){return this.receiver},getSender:function(){return this.sender},getSendTime:function(){return this.sendTime},getReceiveTime:function(){return this.receiveTime},toJSON:function(){var a=this;return{type:"text",from:a.sender,to:a.receiver,time:{send:a.sendTime,receive:a.receiveTime},content:a.content}}});CubeTextMessage.parse=function(a){var b=new CubeTextMessage(a.to.name,a.content);b.receiver.displayName=a.to.displayName;b.sender={name:a.from.name,displayName:a.from.displayName};b.sendTime=a.time.send;b.receiveTime=a.time.receive;return b};var CubeMessageWorker=Class({_msgSizeThreshold:2048,delegate:null,session:null,notifyTimer:0,queryHistoryCallback:null,ctor:function(){},setDelegate:function(a){this.delegate=a},pushMessage:function(c,d){if(null==this.session||null==this.session.name){return false}var e=c;if(typeof c=="string"){if(d!=="undefined"){e=new CubeTextMessage(c,d)}else{return false}}if(e.content.length>this._msgSizeThreshold){this.delegate.didMessageFailed(CubeMessageErrorCode.ContentTooLong,e);return false}if(!nucleus.talkService.isCalled(_M_CELLET)){return false}var a=this;e.sender={name:a.session.name,displayName:a.session.displayName};e.sendTime=Date.now();var b=new ActionDialect();b.setAction(CubeConst.ActionPush);b.appendParam("data",e.toJSON());nucleus.talkService.talk(_M_CELLET,b);this.delegate.didMessageSend(e);return true},queryHistory:function(d,a,e,b){if(null==this.session||null==this.session.name){return false}if(e===undefined){return false}if(d>a){return false}this.queryHistoryCallback=e;var c=new ActionDialect();c.setAction(CubeConst.ActionHistory);c.appendParam("data",{begin:d,end:a});nucleus.talkService.talk(_M_CELLET,c);return true},onRegisterStateChanged:function(a){this.session=a},onDialogue:function(b,a){switch(b){case CubeConst.ActionNotify:this._processNotify(a);break;case CubeConst.ActionPullAck:this._processPullAck(a);break;case CubeConst.ActionHistoryAck:this._processHistoryAck(a);break;default:break}},_processNotify:function(b){if(this.notifyTimer>0){clearTimeout(this.notifyTimer)}var a=this;this.notifyTimer=setTimeout(function(){clearTimeout(a.notifyTimer);a.notifyTimer=0;var c=new ActionDialect();c.setAction(CubeConst.ActionPull);c.appendParam("time",Date.now());nucleus.talkService.talk(_M_CELLET,c)},1000)},_processPullAck:function(c){var e=c.getParam("data");var d=e.messages;for(var b=0;b<d.length;++b){var a=d[b];if(a.type=="text"){var f=CubeTextMessage.parse(a);this.delegate.didMessageReceive(f)}}},_processHistoryAck:function(d){var a=d.getParam("state");if(a.code==200){var f=[];var g=d.getParam("data");var b=g.begin;var e=g.end;var j=g.messages;for(var h=0;h<j.length;++h){var c=j[h];if(c.type=="text"){f.push(CubeTextMessage.parse(c))}}if(null!=this.queryHistoryCallback){this.queryHistoryCallback.call(null,f,b,e);this.queryHistoryCallback=null}}else{}}});