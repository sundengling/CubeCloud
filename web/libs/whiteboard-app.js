(function(a){a.notifyUpload=function(){setTimeout(function(){a.app._requestFileUploadProcess()},3000)},a.app={wb:null,token:null,toolbarHeight:34,tbButtons:null,curLineWeight:2,curColorIndex:0,colors:["#fb3838","#800000","#f7883a","#ffff00","#308430","#99cc00","#385ad3","#3894e4","#800080","#f31bf3","#009999","#16dcdc","#000000","#ffffff","#808080","#c0c0c0"],resizeTimer:0,slideImageList:null,slideCursor:0,uploadProcessTimer:0,selectDefault:function(){if($("#btn_default").hasClass("btn-selected")){return}for(var d=0;d<this.tbButtons.length;++d){var c=this.tbButtons[d];c.removeClass("btn-selected");if(!c.hasClass("btn-default")){c.addClass("btn-default")}}$("#btn_default").removeClass("btn-default");$("#btn_default").addClass("btn-selected");this.wb.unselect();$("#group_draw_option").hide()},selectPencil:function(){if($("#btn_pencil").hasClass("btn-selected")){return}for(var e=0;e<this.tbButtons.length;++e){var c=this.tbButtons[e];c.removeClass("btn-selected");if(!c.hasClass("btn-default")){c.addClass("btn-default")}}$("#btn_pencil").removeClass("btn-default");$("#btn_pencil").addClass("btn-selected");var d=new PencilEntity();d.weight=this.curLineWeight;d.color=this.colors[this.curColorIndex];this.wb.selectEntity(d);$("#group_draw_option").show()},setLineWeight:function(b){$("#btn_line_weight .icon").removeClass("icon-line-weight-"+this.curLineWeight).addClass("icon-line-weight-"+b);this.curLineWeight=b;var c=this.wb.entity();if(c.name==PencilEntity.Name){c.weight=b}$("#btn_line_weight").popover("hide")},setDrawColor:function(b){$("#btn_draw_color .icon").removeClass("icon-color-"+this.curColorIndex).addClass("icon-color-"+b);this.curColorIndex=b;var c=this.wb.entity();if(c.name==PencilEntity.Name){c.color=this.colors[b]}$("#btn_draw_color").popover("hide")},setBgImage:function(b){this.wb.selectEntity(new BackgroundImageEntity(b))},startSlide:function(b){Logger.d("WhiteboardApp","Start slide: "+b.length);this.slideImageList=b;this.wb.selectEntity(new BackgroundImageEntity(b[0]));this.slideCursor=0;$("#page_info").text("1 / "+b.length);if(!$("#btn_prev").parent().hasClass("disabled")){$("#btn_prev").parent().addClass("disabled")}if(b.length==1){if(!$("#btn_next").parent().hasClass("disabled")){$("#btn_next").parent().addClass("disabled")}}else{$("#btn_next").parent().removeClass("disabled")}},clearSlide:function(){Logger.d("WhiteboardApp","Clear slide");this.slideImageList=null;if($("#btn_prev").parent().hasClass("disabled")){$("#btn_prev").parent().removeClass("disabled")}if($("#btn_next").parent().hasClass("disabled")){$("#btn_next").parent().removeClass("disabled")}$("#page_info").text("无幻灯片");this.wb.cleanup()},prevSlide:function(){if(null==this.slideImageList){return}if(this.slideCursor==0){return}this.wb.erase();--this.slideCursor;this.wb.selectEntity(new BackgroundImageEntity(this.slideImageList[this.slideCursor]));this._updateSlide()},nextSlide:function(){if(null==this.slideImageList){return null}if(this.slideCursor==this.slideImageList.length-1){return}this.wb.erase();++this.slideCursor;this.wb.selectEntity(new BackgroundImageEntity(this.slideImageList[this.slideCursor]));this._updateSlide()},skipToSlide:function(b){},_updateSlide:function(){if(this.slideCursor==0){$("#btn_prev").parent().addClass("disabled")}else{$("#btn_prev").parent().removeClass("disabled")}if(this.slideCursor==this.slideImageList.length-1){$("#btn_next").parent().addClass("disabled")}else{$("#btn_next").parent().removeClass("disabled")}$("#page_info").text((this.slideCursor+1)+" / "+this.slideImageList.length)},selectBgImage:function(b){this.wb.selectEntity(new BackgroundImageEntity(b))},resize:function(){var c=document.body.clientHeight;var b=c-this.toolbarHeight-11;$("#app_stage").height(b);this.wb.resize(document.body.clientWidth,b)},notifyOnProgressAlertInfo:function(c){var b=$("#_share_manager_frame")[0].contentWindow;if(null!==b){b.onProgressAlert(c)}else{setTimeout(notifyOnProgressAlertInfo(c),100)}},notifyOnProgress:function(c){var b=$("#_share_manager_frame")[0].contentWindow;if(null!==b){b.onProgress(c)}else{setTimeout(notifyOnProgress(c),100)}},notifyOnConvertCompleted:function(){var b=$("#_share_manager_frame")[0].contentWindow;if(null!==b){b.onConvertCompleted()}else{setTimeout(notifyOnConvertCompleted,100)}},norifyOnConvertFailed:function(){var b=$("#_share_manager_frame")[0].contentWindow;if(null!==b){b.onConvertFailed()}else{setTimeout(norifyOnConvertFailed(),100)}},_requestFileUploadProcess:function(){var b=this;$.post("share/fileprocess",{},function(f,h,d){if(f.state==200){var g=f.data.bytesread;var c=f.data.contentlength;if(g==c){b.notifyOnProgressAlertInfo("上传完成，正在处理文档，请稍候…");b._requestConvertProcess()}else{console.log("File Upload Process [Read: "+g+", ContentLength: "+c);b.notifyOnProgressAlertInfo("上传进度："+g+"/"+c);var e=g/c*100;console.log("progress.value : "+e);if(e<=90){b.notifyOnProgress(e)}b.uploadProcessTimer=setTimeout(function(){b._requestFileUploadProcess()},3000)}}else{}},"json")},_requestConvertProcess:function(){var b=this;$.post("share/convertprocess",{},function(e,g,c){if(e.state==200){var d=e.data.convertstate;console.log("File Convert State: "+d);if(d=="notstart"){setTimeout(function(){b._requestConvertProcess()},2000)}else{if(d=="started"){b.notifyOnProgressAlertInfo("正在处理文档，请稍候…");b.notifyOnProgress(92);setTimeout(function(){b._requestConvertProcess()},2000)}else{if(d=="executing"){b.notifyOnProgress(95);setTimeout(function(){b._requestConvertProcess()},2000)}else{if(d=="completed"){b.notifyOnConvertCompleted();$("#modal_share_file").modal("hide");var f=e.data.filename;b._requestFileUrlList(f)}else{if(d=="failed"){b.norifyOnConvertFailed()}else{setTimeout(function(){b._requestConvertProcess()},2000)}}}}}}else{}},"json")},_requestFileUrlList:function(c){var b=this;$.get("share/fileurllist",{token:b.token,fileName:c},function(f,g,e){if(f.state==200){var d=f.data.urllist;app.wb.erase();app.startSlide(d)}else{}},"json")},onResize:function(){if(this.resizeTimer>0){clearTimeout(this.resizeTimer)}var b=this;this.resizeTimer=setTimeout(function(){clearTimeout(b.resizeTimer);b.resizeTimer=0;b.resize()},60)}}})(window);$(document).ready(function(p){var k=window.utils.getUrlParams();var h=k.token;var n=k.cn;var i=k.cgn;var j=k.pcn;var b=k.debug;if(i===undefined){i=null}if(j===undefined){j=null}window.app.token=h;if(window.cube.startup(b)){window.app.wb=window.cube.loadWhiteboard("canvas");window.app.wb.shareWith([(null!=i)?i:j]);window.cube.registerAccount(n,"123456")}else{console.log("Cube Engine 启动失败")}$(window).resize(function(c){app.onResize()});app.resize();app.tbButtons=[$("#btn_default"),$("#btn_pencil")];$(".toolbar").tooltip({selector:'[data-toggle="tooltip"]',container:"body"});$(".pagination").tooltip({selector:'[data-toggle="tooltip"]',container:"body"});$("#btn_default").click(function(c){app.selectDefault()});$("#btn_pencil").click(function(c){app.selectPencil()});$("#btn_undo").click(function(c){app.wb.undo()});$("#btn_redo").click(function(c){app.wb.redo()});$("#btn_erase").click(function(c){app.wb.erase()});$("#btn_clear").click(function(c){app.clearSlide()});var g='<div class="popover popover-template" role="tooltip"><div class="arrow"></div>		<div class="btn-group popover-line-weight" role="group">			<button id="btn_pencil_weight" type="button" onclick="javascript:app.setLineWeight(2);" class="btn btn-default opt-item-btn" title="细">				<span class="icon icon-line-weight-2" aria-hidden="true">●</span>			</button>			<button id="btn_pencil_color" type="button" onclick="javascript:app.setLineWeight(4);" class="btn btn-default opt-item-btn" title="中">				<span class="icon icon-line-weight-4" aria-hidden="true">●</span>			</button>			<button id="btn_pencil_color" type="button" onclick="javascript:app.setLineWeight(8);" class="btn btn-default opt-item-btn" title="粗">				<span class="icon icon-line-weight-8" aria-hidden="true">●</span>			</button>		</div></div>';$("#btn_line_weight").popover({template:g,html:true,placement:"top"});var m='<div class="popover popover-template" role="tooltip"><div class="arrow"></div>		<table class="popover-draw-color">';var t=[m];var f=app.colors.length/4;var s=app.colors.length/f;var o=0;for(var a=0;a<s;++a){t.push("<tr>");for(var q=0;q<f;++q){var d='<td><button type="button" onclick="javascript:app.setDrawColor('+o+');" class="btn btn-default opt-item-btn"><span class="icon icon-color-'+o+'" aria-hidden="true">▇</span></button></td>';++o;t.push(d)}t.push("</tr>")}t.push("</table></div>");m=t.join("");t=null;$("#btn_draw_color").popover({template:m,html:true,placement:"top"});var l=function(){var c=$("#_share_manager_frame")[0].contentWindow;if(c!==null){c.reset();c.onShare()}else{setTimeout(l,100)}$("#modal_share_file").modal("show")};$("#btn_share").click(l);$("#btn_prev").click(function(c){app.prevSlide()});$("#btn_next").click(function(c){app.nextSlide()});$("#btn_skip").click(function(c){app.skipToSlide()})});